---
title: "Data Rescue: ISCN3 Feb 2026"
format:
  html:
    toc: true
    eval: false #default to not evaluating the chunks, override this the template is completed
    code-fold: true
date: last-modified
date-format: YYYY-MMMM
bibliography:
  - ISCN3_Contributions.bib  #contains the citations for contributed datasets by authors
  - ISCN3_2015.bib #contains citation for the data source, generally a single citation of the primary paper
nocite: |
  @* #add all citations
authors: #author scheme from https://quarto.org/docs/journals/authors.html
  - id: ktoddbrown #use the github name as an id
    name:
      given: Katherine
      family: Todd-Brown
    orcid: 0000-0002-3109-8130
    affiliation:
      - ref: uf-ees
    role: #TODO define these roles and add reference
      - transcription: lead #secondary, review
      - standardization: lead #review
      - curation: lead #review
  - id: vaasukimarupaka
    name:
      given: Vaasuki
      family: Marupaka
    affiliation:
      - ref: uf-ees
    role:
      - transcription: lead #secondary, review
      - standardization: lead
affiliations:
  - id: uf-ees
    name: University of Florida
    department: Environmental Engineering Sciences
    city: Gainesville
    state: Florida
    country: USA
    address: "365 Weil Hall \nP.O. Box 116580"
    postal-code: 32611
    url: https://essie.ufl.edu/ees/
---

The purpose of this document is to summarize the International Soil Carbon Network Database and demonstrate how to use the `readISCN3` function.

> The ISCN is an international scientific community devoted to the advancement of soil carbon research. The ISCN manages an open-access, community-driven soil carbon database. This is version 3-1 of the ISCN Database, released in December 2015. It gathers 38 separate data set contributions, totaling 67,112 sites with data from 71,198 soil profiles and 431,324 soil layers. For more information about the ISCN, its scientific community and resources, data policies and partner networks visit: http://iscn.fluxdata.org/. For information about processes used to construct the DB: https://iscn.fluxdata.org/data/data-information/.

*Data source citation:* Nave, L., K. Johnson, C. van Ingen, D. Agarwal, M. Humphrey, and N. Beekwilder. 2022. International Soil Carbon Network version 3 Database (ISCN3) ver 1. Environmental Data Initiative. https://doi.org/10.6073/pasta/cc751923c5576b95a6d6a227d5afe8ba (Accessed 2024-06-13).


```{r}
#| label: setup
#| include: true
#| warning: false
#| message: false
#| echo: false



# libraries
library(tidyverse) # data processing
library(kableExtra) # pretty tables
library(bibtex) # reading in BibTex files to R
library(pdftools)
#install.packages("tabulapdf")
#library(tabulapdf)

# data directory, primary annotations & control vocabularies
dataDownload.dir <- 'temp'
dataAnnotations <- 'ISCN3Annotations.csv'
controlVocabulary <- 'ISCN3_2015_Control_vocab.csv'

# Bibliograph files
primaryCitation.file <- 'ISCN3_2015.bib'
contributionsCitation.file <- 'ISCN3_Contributors.bib'

# read function
readsource.file <- '../../01_DataRescue/ISCN3_2015/readISCN3.R'
source(readsource.file)

#semantic files for level 1
of_variable.file <- '../../02_DataHarmonization/of_variable.csv'
is_type.file <- '../../02_DataHarmonization/is_type.csv'

```

## Fit for purpose: ISCN 2025

This data is identified as a data source for ISCN2025.
The purpose ISCN 2025 (aka ISCN4) is to create a data product aggregating data on geo-located soil organic carbon profiles.
With this data we will examine the assumption of steady state on field surveyed organic carbon.

ISCN3 contains four primary data tables:: a `profile` table containing the profile information, a `layer` table containing layer level data for the different soil profiles, a `citation` table containing the citation and additional references information for the contributed datasets and finally a `dataset` table with study information.
.
These data annotation table is provided in a `<id>-of_variable-is_type-with_entry` tuple data model.

## Files

<!--- Include a brief explanation to all the files in the folder--->

These files are in the ISCN3 data rescue.

- [README_ISCN3.qmd](README_ISCN3.qmd)
  + This is the primary file that documents the transcriptions and decision made during data rescue.
- [ISCN3_2015.bib](ISCN3_2015.bib)
  + citation for project website and primary journal article transcribed
- [ISCN3_Contributors.bib](ISCN3_Contributors.bib)
  + citations for the contributed data sets to ISCN
- [temp/](temp/)
  + the download location for ISCN3 files archived on EDI web portal

## Download ISCN3

The ISCN3 is downloaded from EDI (@ISCN3).
Below we loop through the files that are expected and download them.

```{r}
#| label: dataDownloadEDI
#| code-summary: "Download and identify each file in the EDI package."

### Download the data ####
# link the table name to the download url and file path(s) for data package
pasta_package <- 'https://pasta.lternet.edu/package/data/eml/edi/1160/1/'

download_table <- tibble::tribble(
  ~table, ~entity_id, ~file_name, 
  'layer', "4af719a84f8981fcc63f1f92760cb253", 'ISCN3_layer.csv',
  'profile', "40527580cc045d33d9a5aaf728bf204e", 'ISCN3_profile.csv',
  'citation', "320e31ca911f187550ca2143c31fd408", 'ISCN3_citation.csv',
  'dataset', "cdd0c7a4cac3f28d6d788c91f506775f", 'ISCN3_dataset.csv',
  'control_vocabulary', "a8eef6e94b669b365e443c15d9402a03", 'ISCNTranscribed_TemplateCVs.xlsx',
  'template', "cb5c1cd86e9ab17f699f7a05044325b7", 'ISCNtemplate.xlsx',
  'other_pdfs', "eb320ae7b57296765f543cbb370b0f24", 'TemplateCVs.pdf',
  'other_pdfs', "b81a7f4214d176280a5ff4e0f0d52d8b", 'TemplateSubmit.pdf')

#One by one, download the data in each row from the download_table
#... and store that in the appropriate file path location on your computer
for(row_index in 1:nrow(download_table)){
  if(!file.exists(file.path(dataDownload.dir,download_table$file_name[row_index]))){
    print(paste('Download file:', 
                download_table$file_name[row_index]))
    utils::download.file(
      paste0(pasta_package, download_table$entity_id[row_index]), 
      file.path(dataDownload.dir,download_table$file_name[row_index]))
  }
}

```

# Data annotation

Describe the construction of the data annotation as a manual process.
Give the user part of the table to show what is in the annotation


# Level 0 data

*TODO*:

 1) Transcribe all the excel and pdf tables as csv data rescue objects
 2) Read in the 'data' files, the annotation file, and the rescued data objects to a level 0
 3) update the read file (including the newly rescued elements)
 4) update the read function to include the new downloads table above
 5) Only call the read function to check that the level 0 output is identical to the code. Make the table reads below look like the template.
 6) remember to fix the bib file, note which dataset does not exist
 
 **Be sure to render the quarto**

Data is available for download (@EDI portal).

Below is an example of how to use the `readISCN3` function and basic reporting on the soil organic carbon related measurements.

```{r}
iscn.ls <- readISCN3(dataDir = dataDir,
                     annotationFilename = dataAnnotations,
                     format = 'level0')
```

## Table: `citation`

```{r}
knitr::kable(iscn.ls$annotation |>
               dplyr::filter(is_type == 'description',
                      table_id == 'citation') |>
               dplyr::select(column_id, of_variable, description = with_entry)) |>
  kable_paper() |>
  scroll_box(width = "100%", height = "300px")
```

## Table: `dataset`

```{r}
knitr::kable(iscn.ls$annotation |>
               dplyr::filter(is_type == 'description',
                      table_id == 'dataset') |>
               dplyr::select(column_id, of_variable, description = with_entry)) |>
  kable_paper() |>
  scroll_box(width = "100%", height = "300px")
```

## Table: `profile`

```{r}
knitr::kable(iscn.ls$annotation |>
               dplyr::filter(is_type == 'description',
                      table_id == 'profile') |>
               dplyr::select(column_id, of_variable, description = with_entry)) |>
  kable_paper() |>
  scroll_box(width = "100%", height = "300px")
```

## Table: `layer`

```{r}
knitr::kable(iscn.ls$annotation |>
               dplyr::filter(is_type == 'description',
                      table_id == 'layer') |>
               dplyr::select(column_id, of_variable, description = with_entry)) |>
  kable_paper() |>
  scroll_box(width = "100%", height = "300px")
```


